<!DOCTYPE HTML>
<HTML xmlns:Grid>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>    
<meta charset="UTF-8">
<title>文章管理</title>

<link href="../../tools/tssJS/css/boubei.css" rel="stylesheet">
<link href="../../tools/tssJS/fonts/icons.css" rel="stylesheet" >
<link href="../../css/css.css" rel="stylesheet">

<script src="../../tools/tssJS/tssJS.all.js"></script>
<script src="../../tools/tssUtils.js"></script>

<script src="../../tools/kindeditor/kindeditor.js"></script>
<script src="../../tools/kindeditor/lang/zh_CN.js"></script>

<style type="text/css">
	body { overflow: auto; height: auto; width: 99%; }

	.article {  background-color: #fff; margin: 0 2px; height: 100%;}
	.article .summary { background-color: #fff; padding: 3px; }
	.article .content { height: 380px; }
	.article .attach  { height: 90px; }
	.article .upload  { background-color: #E0ECFF; padding: 5px 0 5px 10px; }
	.article .bts { border-top: 1px solid #ccc; padding: 5px 0 5px 10px; text-align: center; }
	.article .bts input { margin-right:20px; }
	
	#content { width:99%; height:375px; visibility:hidden; }

	.ke-dialog-body input {  height: 20px; margin: 3px 2px; }

	.ke-icon-imageSelf {
		background-image: url(../../tools/kindeditor/themes/default/default.png);
		background-position: 0px -496px;
		width: 16px;
		height: 16px;
	}
	.imageSelf {
		width: 250px;
		height: 22px;
		line-height: 22px;
		margin-top: 5px;
	}

	.ke-icon-reportportlet {
		background-image: url(../../tools/kindeditor/themes/default/default.png);
		background-position: 0px -560px;
		width: 16px;
		height: 16px;
	}

	.ke-icon-urlLink {
		background-image: url(../../tools/kindeditor/themes/default/default.png);
		background-position: 0px -1040px;
		width: 16px;
		height: 16px;
	}
	
</style>

<script type="text/javascript">
<!--
	
	/* XMLHTTP请求地址汇总 */
    URL_ARTICLE_DETAIL = AUTH_PATH + "article/";       // {articleId}
	URL_ARTICLE_INIT   = AUTH_PATH + "article/init/";  // {channelId}
    URL_SAVE_ARTICLE   = AUTH_PATH + "article";
    URL_SET_ATTACH_TOP = AUTH_PATH + "article/attach/top/"; // {id}

	if(window.parent == window.self) {
		URL_ARTICLE_DETAIL = "data/article.xml?";
		URL_ARTICLE_INIT   = "data/article.xml?";
		URL_SAVE_ARTICLE   = "data/_success.xml?";
		URL_SET_ATTACH_TOP = "data/_success.xml?";
	}

	// 自定义插件 #1
	KindEditor.lang({
		imageSelf : '插入文章附件'
	});
	KindEditor.plugin('imageSelf', function(K) {
		var self = this, name = 'imageSelf';
		self.clickToolbar(name, function() {
			var html = [];
			html.push('<div style="margin:20px;">');
			html.push('可选附件：<select class="imageSelf" id="attachSelector">');
			$("#attachGrid tbody>tr").each(function(i, row){
				if( $('td', row).length == 0 ) return;

				var name = $('td[name=name]', row).attr('value');
				var url  = NO_AUTH_PATH + $('td[name=relationUrl]', row).attr('value');
				if(articleId > 1000000000) { // 文章新建未保存
					url += "&channelId=" + channelId;
				}
				var type = $('td[name=type]', row).attr('value');
				html.push('<option value="' + (type + "," + url + ", " + name) + '">' + $('td[name=name]', row).attr('value') + '</option>');
			});
			html.push('</select>');
			html.push('<br/>添加说明：<input class="imageSelf" id="attachRemark">');
			html.push('</div>');
			self.createDialog({
				name : 'imageSelf',
				width : 450,
				title : '选择要插入的图片或文档',
				body : html.join('\n'),
				yesBtn : {
					name : "插入",
					click : function(e) {
						var html;
						var title = $("#attachRemark").value();
						var attach = $("#attachSelector").value();
						if(!attach) {
							return alert("您没有选择附件，请选择一个再点插入");
						}
						attach = attach.split(',');
						if(attach[0] == '1') {
							title = title || attach[2];
							html = '<img class="imgAttach" src="' + attach[1] + '" alt="' + title + '"></img>';
						} else {
							html = '<a class="docAttach" href="' + attach[1] + '" target="_blank">' + title + '</a>';
						} 
						self.insertHtml(html);
						self.select().hideDialog().focus();
					}
				}
			});
		});
	});

	KindEditor.lang({
		reportportlet : '插入报表Portlet'
	});
	KindEditor.plugin('reportportlet', function(K) {
		var self = this, name = 'reportportlet';
		self.clickToolbar(name, function() {
			var html = [];
			html.push('<div style="margin:20px;line-height:22px;">');
			html.push('报表ID ：<input id="reportId" style="width:100px;">');
			html.push('<br/>报表宽度：<input id="reportWidth" value="100%" style="width:100px;">&nbsp;&nbsp;&nbsp;&nbsp;');
			html.push('报表高度：<input id="reportHeight" value="600px" style="width:100px;">');
			html.push('<br/>报表参数1：<input id="reportParam1" style="width:300px;">');
			html.push('<br/>报表参数2：<input id="reportParam2" style="width:300px;">');
			html.push('<br/>报表参数3：<input id="reportParam3" style="width:300px;">');
			html.push('<br/>报表参数4：<input id="reportParam4" style="width:300px;">');
			html.push('<br/>报表参数5：<input id="reportParam5" style="width:300px;">');
			html.push('</div>');

			self.createDialog({
				name : 'reportportlet',
				width : 450,
				title : '插入报表Portlet',
				body : html.join('\n'),
				yesBtn : {
					name : "插入",
					click : function(e) {
						var reportId = $("#reportId").value();
						if(!reportId) {
							return alert("报表ID不能为空");
						}

						var url = "/tss/modules/dm/report_portlet.html?id=" + reportId;

						for(var i=1; i <= 5; i++) {
							var tempV =  $('#reportParam' + i).value();
							if(tempV) {
								url += '&param' + i + '=' + tempV;
							}
						}
						
						var reportWidth = $("#reportWidth").value() || "100%";
						var reportHeight = $("#reportHeight").value() || "600px";
						var style = "width:" + reportWidth + ";height:" + reportHeight + ";";
						var html = '<iframe src="' + url + '" frameborder="0" style="' + style + '"></iframe>';

						self.insertHtml(html);
						self.select().hideDialog().focus();
					}
				}
			});
		});
	});

	KindEditor.lang({
		urlLink : '插入超链接'
	});
	KindEditor.plugin('urlLink', function(K) {
		var self = this, name = 'urlLink';
		self.clickToolbar(name, function() {
			var html = [];
			html.push('<div style="margin:20px;line-height:22px;">');
			html.push('链接地址：<input id="urlValue" style="width:300px;">');
			html.push('<br/>链接说明：<input id="urlTitle" style="width:120px;">');
			html.push('</div>');

			self.createDialog({
				name : 'urlLink',
				width : 450,
				title : '插入超链接',
				body : html.join('\n'),
				yesBtn : {
					name : "插入",
					click : function(e) {
						var url = $("#urlValue").value();
						var title = $("#urlTitle").value() || '点击链接查看';
						var html = '<a href="' + url + '" target="self">' +title+ '</a>';

						self.insertHtml(html);
						self.select().hideDialog().focus();
					}
				}
			});
		});
	});


	var editor;
	KindEditor.ready( function(K) {
		editor = K.create('textarea[name="content"]', {
				resizeType: 1,
				allowPreviewEmoticons : false,
				allowImageUpload : false,
				items : [
					'fontname', 'fontsize', 
					'|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline', 'lineheight', 'removeformat', 
					'|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist', 'insertunorderedlist', 
					'|', 'media', 'imageSelf', 'urlLink', 'reportportlet', 'table', 'baidumap', 
					'|', 'source', 'fullscreen', 'quickformat', 'preview']
			});				
	} );

	var channelId;
    var articleId;

	function init() {
		if(window.parent && window.parent.globalValiable) {
			var globalValiable = window.parent.globalValiable;
			channelId = globalValiable.channelId;
			articleId = globalValiable.articleId;
		}

		initGridMenu();

		var url, isNew = !articleId;
		if(articleId) {
			url = URL_ARTICLE_DETAIL + articleId;
		} else {
			url = URL_ARTICLE_INIT + channelId; 
			articleId = $.now(); // 取当前时间作为新文章的临时ID，上传附件时有用
		}

        var onresult = function(){
            var articleInfoNode    = this.getNodeValue("ArticleInfo");
            var articleContentNode = this.getNodeValue("ArticleContent");
            var attachsListNode    = this.getNodeValue("AttachsList");

			var xform = $.F("articleForm", articleInfoNode);
			editor.insertHtml(articleContentNode);
			attachReminder(articleId, xform); // 离开提醒

			var grid = $.G("attachGrid", attachsListNode);
			grid.element.onRightClickRow = function() {
				grid.element.contextmenu.show(event.clientX, event.clientY);
			} 
			grid.element.onDblClickRow = function(eventObj) {
				delAttach();
			}

            $("#btSave").click( function() { saveArticle(false); } );
            $("#btSaveAndPublish").click( function() { saveArticle(true); } );

            var title = $.Query.get("title");
		    if(isNew && title) {
		    	xform.updateDataExternal("title", decodeURI(title));    
    			xform.updateData( $1("title") );
		    }

		    setTimeout(function(){
		    	$(".ke-container").width("");
		    }, 500);
        }
        
		$.ajax({ url: url, method: "GET", onresult: onresult });
	}
 
    function saveArticle(isCommit) {
        var articleForm = $.F("articleForm");
        if( !articleForm.checkForm() ) return;

        var request = new $.HttpRequest();
        request.url = URL_SAVE_ARTICLE;
        request.addParam("channel.id", channelId); // 文章所属栏目
        request.addParam("articleId", articleId); 

        // 文章基本信息
        var articleInfoNode = articleForm.template.sourceXML;
		var dataNode = articleInfoNode.querySelector("data");
		request.setFormContent(dataNode);

		// 文章正文
		var _articleContent = editor.html();
		if( _articleContent.indexOf("data:image/png;base64") > 0 ) {
			return alert("请先将正文中复制进来的图片保存到本地目录，再通过编辑器下方的【上传附件】上传后插入到正文里。");
		}
		request.addParam("ArticleContent", _articleContent);

		// 文章图片附件
		var attachsSeqNos = $.G("attachGrid").getColumnValues("seqNo");
		request.addParam("attachList", attachsSeqNos.join(","));

		// 是否保存并发布文章
		request.addParam("isCommit", isCommit ? "true" : "false");
       
		// 同步按钮状态
        syncButton([$1("btSave")], request);

        request.onsuccess = function() {
           // 刷新框架页的对应栏目的文章列表
           window.parent.showArticleList(channelId); 
        }
        request.send();
    }

	function uploadAttachment() {
		var fileValue = $("#sourceFile").value();
	    if( !fileValue ) {
	         return $("#sourceFile").notice("您还没有选择文件，请选择一个文件再点上传!");               
	    }

	    if( checkUploadFile(fileValue) ) {
	        return $.tssTip("当前后缀类型的文件已被禁止上传。");
	    }
    
		var url = URL_UPLOAD_FILE + "?afterUploadClass=com.boubei.tss.cms.CreateAttach";
		url += "&articleId=" + articleId;	
		url += "&channelId=" + channelId;
		url += "&type=" + $1("fileType").value;
		
		var form = $1("uploadForm");
		form.action = url;
		form.submit();

		// 清空file input，防止重复上传
    	tssJS("#sourceFile").value("");
	}

	function addAttachments(seqNo, fileName, fileExt, oldfileName, downloadUrl, relationUrl) {
		var type = $1("fileType").value;
		var map = {
			"seqNo": seqNo, 
			"articleId": articleId, 
			"type": type, 
			"name": oldfileName, 
			"downloadUrl": downloadUrl, 
			"relationUrl": relationUrl,
			"fileName": fileName, 
			"fileExt": fileExt,
			"_url": "<a href='/tss/" + relationUrl + "' target='_blank'>查看</a>", 
	        "delOpt": "<a href='javascript:void(0)' onclick='delAttach()'>删除</a>", 
	        "uploadDate": tssJS.now(true)
		};
		$.G("attachGrid").insertRow(map);
	}

	function delAttach() {
		$.confirm("您确定要删除该附件吗？", "删除确认", function(){
			$.G("attachGrid").deleteSelectedRow();
		});
	}

	function setTop(attachId) {
	    tssJS.post(URL_SET_ATTACH_TOP + attachId, {}, function(attach) {
	    		tssJS.tssTip("置顶成功，重新打开文章生效。")
	            tssJS.hideWaitingLayer();
	        }
	    );
	}

	function initGridMenu() { 
        var item1 = {
            label:"删除",
            callback:delAttach,
            icon:"icon icon-x",
        }

        var menu1 = new $.Menu();
        menu1.addItem(item1);
 
        $1("attachGrid").contextmenu = menu1;
    }

	window.onload = init;

//-->
</script>

</head>

<body>

	<div class="article">
		<div class="summary">
			<div id="articleForm"></div>
		</div>
		<div class="content">
			<textarea id="content" name="content"></textarea>
		</div>
		<div class="upload">
			<form id="uploadForm" method="post" target='fileUpload' enctype="multipart/form-data">
				附件类型: 
				<select id="fileType">
					<option value="1" selected>图片</option>
					<option value="2">文档</option>
				</select>
				<input type="file" name="file" id="sourceFile" multiple="multiple"/>
				<input type="button" class="tssbutton small blue" onclick="uploadAttachment()" value="上传附件" />
				<b>&nbsp;单个附件大小不宜超过3M</b>
			</form>
			<iframe name='fileUpload' style='display:none;'></iframe>
		</div>
		<div class="attach">
			<Grid id="attachGrid" height="90"></Grid>
		</div>
		<div class="bts">
			<input type="button" value="保 存" class="tssbutton small blue" id="btSave"/> 
			<input type="button" value="保存并提交" class="tssbutton small blue" id="btSaveAndPublish"/>
			<input type="button" value="关 闭" class="tssbutton small blue" onclick="window.parent.showArticleList(channelId);"/>
			<input type="button" value="查看帮助" class="tssbutton small green" onclick="window.open('https://www.boudata.com/tss/article.portal?articleId=168');"/>
		</div>
	</div>

</body>
</html>